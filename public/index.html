<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系統狀態監控</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="main-wrapper">
        <h1><span id="hostnameDisplay"></span>系統狀態監控儀表板</h1>

        <div class="stats-container">
        <!-- CPU Row -->
        <div class="stat-row">
            <div class="card">
                <h2>CPU</h2>
                <div class="chart-container">
                    <canvas id="cpuChart"></canvas>
                    <div class="percentage" id="cpuPercent">... %</div>
                </div>
                <div class="info">
                    <p><strong>核心數:</strong> <span id="cpuCores">...</span></p>
                </div>
            </div>
            <div class="timeseries-card">
                <canvas id="cpuTimeSeriesChart"></canvas>
            </div>
        </div>

        <!-- GPU Row -->
        <div class="stat-row">
            <div class="card">
                <h2>GPU</h2>
                <div class="chart-container">
                    <canvas id="gpuChart"></canvas>
                    <div class="percentage" id="gpuPercent">... %</div>
                </div>
                <div class="info">
                    <p><strong>型號:</strong> <span id="gpuModel">讀取中...</span></p>
                </div>
            </div>
            <div class="timeseries-card">
                <canvas id="gpuTimeSeriesChart"></canvas>
            </div>
        </div>

        <!-- RAM Row -->
        <div class="stat-row">
            <div class="card">
                <h2>RAM</h2>
                <div class="chart-container">
                    <canvas id="ramChart"></canvas>
                    <div class="percentage" id="ramPercent">... %</div>
                </div>
                <div class="info">
                    <p><strong>已使用:</strong> <span id="ramUsed">...</span></p>
                    <p><strong>總共:</strong> <span id="ramTotal">...</span></p>
                </div>
            </div>
            <div class="timeseries-card">
                <canvas id="ramTimeSeriesChart"></canvas>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script>
        const MAX_DATA_POINTS = 2500; // 時序圖顯示的最大數據點數量

        // ---------------------------------
        // 1. 獲取所有 Canvas 上下文
        // ---------------------------------
        const cpuCtx = document.getElementById('cpuChart').getContext('2d');
        const ramCtx = document.getElementById('ramChart').getContext('2d');
        const gpuCtx = document.getElementById('gpuChart').getContext('2d');
        const cpuTsCtx = document.getElementById('cpuTimeSeriesChart').getContext('2d');
        const ramTsCtx = document.getElementById('ramTimeSeriesChart').getContext('2d');
        const gpuTsCtx = document.getElementById('gpuTimeSeriesChart').getContext('2d');

        // ---------------------------------
        // 2. 建立圖表的輔助函數
        // ---------------------------------
        // 建立環圈圖
        function createUsageChart(ctx) {
            return new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['已使用', '未使用'],
                    datasets: [{
                        data: [0, 100],
                        backgroundColor: ['rgba(75, 192, 192, 0.7)', 'rgba(255, 255, 255, 0.1)'],
                        borderColor: 'rgba(44, 48, 59, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: { legend: { display: false }, tooltip: { enabled: false } }
                }
            });
        }

        // 建立時序圖 (折線圖)
        function createTimeSeriesChart(ctx, label, color) {
            return new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: label,
                        data: [], // 格式: {x: timestamp, y: value}
                        borderColor: color,
                        backgroundColor: color.replace('1)', '0.2)'),
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            display: true,
                            time: {
                                unit: 'second',
                                stepSize: 10,
                                tooltipFormat: 'HH:mm:ss',
                                displayFormats: {
                                    second: 'HH:mm:ss'
                                }
                            },
                            ticks: { 
                                color: '#c0caf5',
                                maxRotation: 0,
                                minRotation: 0
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#c0caf5' }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { color: '#c0caf5', font: { size: 14 } }
                        }
                    }
                }
            });
        }

        // ---------------------------------
        // 3. 初始化所有圖表
        // ---------------------------------
        const cpuChart = createUsageChart(cpuCtx);
        const ramChart = createUsageChart(ramCtx);
        const gpuChart = createUsageChart(gpuCtx);
        const cpuTimeSeriesChart = createTimeSeriesChart(cpuTsCtx, 'CPU 使用率 (%)', 'rgba(156, 204, 101, 1)');
        const ramTimeSeriesChart = createTimeSeriesChart(ramTsCtx, 'RAM 使用率 (%)', 'rgba(77, 182, 172, 1)');
        const gpuTimeSeriesChart = createTimeSeriesChart(gpuTsCtx, 'GPU 使用率 (%)', 'rgba(126, 87, 194, 1)');

        // ---------------------------------
        // 4. 更新圖表的函數
        // ---------------------------------
        // 更新環圈圖
        function updateDoughnutChart(chart, percentValue, percentText) {
            chart.data.datasets[0].data[0] = percentValue;
            chart.data.datasets[0].data[1] = 100 - percentValue;
            chart.update('none');
            const percentElementId = chart.canvas.id.replace('Chart', 'Percent');
            document.getElementById(percentElementId).innerText = percentText;
        }

        // 更新時序圖
        function updateTimeSeriesChart(chart, value) {
            const now = Date.now();
            chart.data.datasets[0].data.push({ x: now, y: value });

            if (chart.data.datasets[0].data.length > MAX_DATA_POINTS) {
                chart.data.datasets[0].data.shift();
            }
            chart.update('none');
        }

        // ---------------------------------
        // 5. 獲取 API 數據並更新頁面的主函數
        // ---------------------------------
        async function fetchData() {
            try {
                const response = await fetch('/api/stats');
                if (!response.ok) throw new Error('API 請求失敗');
                const data = await response.json();

                // 更新主機名稱
                if (data.hostname) {
                    document.getElementById('hostnameDisplay').innerText = data.hostname + ' - ';
                }

                // --- 更新 CPU ---
                const cpuLoadValue = parseFloat(data.cpu.load) || 0;
                const formattedCpuLoad = cpuLoadValue.toFixed(1) + ' %';
                updateDoughnutChart(cpuChart, cpuLoadValue, formattedCpuLoad);
                updateTimeSeriesChart(cpuTimeSeriesChart, cpuLoadValue);
                document.getElementById('cpuCores').innerText = data.cpu.cores;

                // --- 更新 RAM ---
                const ramUsageValue = parseFloat(data.ram.usage) || 0;
                const formattedRamUsage = ramUsageValue.toFixed(1) + ' %';
                updateDoughnutChart(ramChart, ramUsageValue, formattedRamUsage);
                updateTimeSeriesChart(ramTimeSeriesChart, ramUsageValue);
                document.getElementById('ramUsed').innerText = data.ram.used;
                document.getElementById('ramTotal').innerText = data.ram.total;

                // --- 更新 GPU ---
                if (data.gpu && data.gpu.length > 0) {
                    const gpuData = data.gpu[0];
                    const gpuUtilValue = parseFloat(gpuData.utilization) || 0;
                    const formattedGpuUtil = gpuUtilValue.toFixed(1) + ' %';
                    updateDoughnutChart(gpuChart, gpuUtilValue, formattedGpuUtil);
                    updateTimeSeriesChart(gpuTimeSeriesChart, gpuUtilValue);
                    document.getElementById('gpuModel').innerText = gpuData.model;
                }

            } catch (error) {
                console.error('更新數據時出錯:', error);
            }
        }

        // ---------------------------------
        // 6. 啟動！
        // ---------------------------------
        document.addEventListener('DOMContentLoaded', fetchData);
        setInterval(fetchData, 1000); // 更新頻率設為 1000 毫秒

    </script>
    </div> <!-- 關閉 main-wrapper -->
</body>
</html>